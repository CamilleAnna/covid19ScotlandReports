---
title: "WHO Africa covid19 report"
subtitle: "DRAFT"
author: "COVID-19 Epidemic Response Unit, University of Edinburgh"
output: word_document
extra_dependencies: ["float"]
header-includes: #allows you to add in your own Latex packages
- \usepackage{float} #use the 'float' package
- \floatplacement{figure}{H} #make every figure with caption = h
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
---

#Doing further editing while waiting for Mark's feedback

```{r setup, include=FALSE}

# SET UP CHUNK OPTIONS ----
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(tidy = TRUE)

# DIRECTORIES & DATE SET UP ----
setwd('/Users/s1687811/Desktop/covid19/Africa_report/')
today<- Sys.Date() -2

# LOAD DATA & SOURCE USEFUL FUNCTIONS ----
source('/Users/s1687811/Documents/GitHub/covid19/script/sourced_functions_doublingTime_reports.R')


who.tab<- read.csv('WHO_countries.txt', sep = '\t') # WHO list of countries
colnames(who.tab)<- c('country', 'name_plot')

who<- as.character(read.csv('WHO_countries.txt', sep = '\t')[,1])
pops<- read_excel('Africa_popsizes.xlsx')

d<- 
  read_excel(paste0('./', today, '/Africa_data_', today, '.xlsx'), sheet = 2) %>%
  mutate(date = as.Date(date)) %>%
  as.data.frame() %>%
  select(c(date, which(colnames(.) %in% who)))

who.in<- who[is.element(who, colnames(d))]
who.out<- who[!is.element(who, colnames(d))]

d.long<-
  d %>%
  gather('country', 'cumNumCases', 2:ncol(d))

d.deaths<- 
  read_excel(paste0('./', today, '/Africa_data_', today, '.xlsx'), sheet = 1) %>%
  mutate(date = as.Date(date)) %>%
  as.data.frame() %>%
  select(c(date, which(colnames(.) %in% who)))

d.deaths.long<-
    d.deaths %>%
  gather('country', 'cumNumDeaths', 2:ncol(d.deaths))


d.10k.log.long<- 
  d %>%
  gather('country', 'cumcases', 2:ncol(d)) %>%
  left_join(pops, by = 'country') %>%
  mutate(cumcases_10k = cumcases * (10000/popsize)) %>%
  na_if(0) %>%
  mutate(cumcases_10k_log = log10(cumcases_10k)) %>%
  select(date, country, cumcases_10k_log)

d.10k.log<-
  d.10k.log.long %>%
  spread(country, cumcases_10k_log)


d.deaths.10k.log.long<- 
  d.deaths %>%
  gather('country', 'cumdeaths', 2:ncol(d.deaths)) %>%
  left_join(pops, by = 'country') %>%
  mutate(cumdeaths_10k = cumdeaths * (10000/popsize)) %>%
  na_if(0) %>%
  mutate(cumdeaths_10k_log = log10(cumdeaths_10k)) %>%
  select(date, country, cumdeaths_10k_log)


d.deaths.10k.log<-
  d.deaths.10k.log.long %>%
  spread(country, cumdeaths_10k_log)


palette<- brewer.pal(10, 'Paired')
palette.f1<- c(rep('black', ncol(d) - length(palette)), palette)



```

We compare the size and rate of increase of the COVID-19 epidemic across the countries included in WHO Africa Region.

&nbsp;

The present report is organised as follow:

1. Key points summary text
2. Main summary results
    + Figure 1: Cumulative incidence curves
    + Figure 2: Cumulative incidence curves per 10k population (log10)
    + Figure 3: Map of cumulative incidence
    + Figure 4: Cumulative deaths curves
    + Figure 5: Cumulative deaths curves per 10k population (log10)
    + Figure 6: Cumulative incidence curves, aligned to first days of reported cases
    + Figure 7: Cumulative incidence curves per 10k population (log10), aligned to first days of reported cases
    + Figure 8: Histogram of cumulative cases and deaths
    + Figure 9: Histogram of cumulative incidence per 10k population
    + Figure 10: Doubling times of cumulative incidence per 10k population with 95% CI
3. By country plotted data: one pannel per WHO country, each containing four figures
    + cumulative incidence
    + cumulative incidence per 10k pop. (log10)
    + cumulative deaths
    + cumulative death per 10k pop. (log10)
4. Data
5. Methods
6. Annexes
    + Table reporting all cumulative incidence doubling times
    + Pairwise time difference (in days) of cumulative incidence per 10k population for all countries



# Key points summary

As of `r format(today, "%d/%m/%Y")` ... TBC


# Main summary results

```{r rawCumCases, fig.height = 6, fig.width = 6, fig.align = "center", echo = FALSE}
# Raw cumulative cases ----
yseq = seq(0, max(d.long$cumNumCases) - (max(d.long$cumNumCases) %% 200), 200)
xseq = seq.Date(from = as.Date("2020-03-01"), to = max(d$date), by = 7)

plot('', xlim = range(xseq), ylim = range(yseq), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = format(xseq, "%d/%m"), font = 2)
axis(2, at = yseq, font = 2)
mtext('Cumulative number of cases', side = 2, font = 2, line = 2.2)
mtext('Date (dd/mm)', side = 1, font = 2, line = 2.5)

abline(v = xseq, h = yseq, col = 'grey', lty = 'dotted')

tmp<- gather(tail(d,1)[-1], 'country', 'max') %>% arrange(-max)
d.tmp<- d[,c('date', rev(tmp$country))]

for(c in 2:ncol(d.tmp)){
  lines(d.tmp[,c] ~ d.tmp$date, lwd = 2, col = palette.f1[c])
}

x1 = range(xseq)[1]
x2 = range(xseq)[1] + diff(range(xseq)) * 0.4
y1 = range(yseq)[2]
y2 = range(yseq)[2] * 0.5

polygon(x = c(x1, x1, x2, x2),
        y = c(y1, y2, y2, y1),
        col = adjustcolor('grey', alpha = .2),
        border = NA)


ins.mar = (y1 - y2) * 0.1

topten.tmp<- data.frame(country = (tmp$country)[1:10]) %>%
  left_join(who.tab, by = 'country') %>%
  select(name_plot)

text(x = x1,
     y = rev(seq(y2+ins.mar, y1-ins.mar, length.out = 11)),
     lty = 2,
     labels = c('Region/Country:', paste0(' ', as.character(topten.tmp$name_plot))),
     col = c('black', rev(palette)),
     pos = 4,
     font = c(2, rep(1, 10)),
     cex = 0.8)

rm(tmp)
rm(d.tmp)
rm(topten.tmp)
rm(ins.mar)
```
&nbsp;

**Figure 1. Comparison of epidemic curves for WHO Africa Region as of `r format(today, "%d/%m/%Y")`**. The curves show the cumulated reported cases. The ten countries with the highest current number of cases are highlighted in colors according to legend in the inset.

\newpage

```{r  LogCumPrevCases, fig.height = 6, fig.width = 6, fig.align = "center"}

# Log cumulative cases per 10k pop ----

ylim.f2.min = min(d.10k.log.long$cumcases_10k_log, na.rm = TRUE) - min(d.10k.log.long$cumcases_10k_log, na.rm = TRUE) %% 1
ylim.f2.max = 0


yseq = seq(ylim.f2.min, ylim.f2.max, 1)
xseq = seq.Date(from = as.Date("2020-03-01"), to = max(d.10k.log$date), by = 7)


plot('', xlim = range(xseq), ylim = range(yseq), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = format(xseq, "%d/%m"), font = 2)
axis(2, at = yseq, font = 2)
mtext('Cumulative cases per 10k pop. (log10)', side = 2, font = 2, line = 2.2)
mtext('Date (dd/mm)', side = 1, font = 2, line = 2.5)

abline(v = xseq, h = yseq, col = 'grey', lty = 'dotted')


tmp<- gather(tail(d.10k.log,1)[-1], 'country', 'max') %>% arrange(-max)
d.tmp<- d.10k.log[,c('date', rev(tmp$country))]


for(c in 2:ncol(d.tmp)){
  lines(d.tmp[,c] ~ d.tmp$date, lwd = 2, col = palette.f1[c])
}


x1 = xseq[1]
x2 = xseq[1] + diff(range(xseq)) * 0.4

y1 = range(yseq)[2]
y2 = range(yseq)[1] + diff(range(yseq)) * 0.5

polygon(x = c(x1, x1, x2, x2),
        y = c(y1, y2, y2, y1),
        col = adjustcolor('grey', alpha = .2),
        border = NA)


ins.mar = (y1 - y2) * 0.1

topten.tmp<- data.frame(country = (tmp$country)[1:10]) %>%
  left_join(who.tab, by = 'country') %>%
  select(name_plot)

text(x = x1,
     y = rev(seq(y2+ins.mar, y1-ins.mar, length.out = 11)),
     lty = 2,
     labels = c('Region/Country:', paste0(' ', as.character(topten.tmp$name_plot))),
     col = c('black', rev(palette)),
     pos = 4,
     font = c(2, rep(1, 10)),
     cex = 0.8)

rm(tmp)
rm(d.temp)
rm(topten.tmp)
rm(ins.mar)

```
&nbsp;

**Figure 2. Comparison of prevalence for WHO Africa Region as of `r format(today, "%d/%m/%Y")`**. The curves show the cumulated reported cases per 10000 population on a log10 scale. The ten countries with the highest current prevalence are highlighted in colors according to legend in the inset.


\newpage

&nbsp;


```{r map, fig.align = 'center', out.width= "75%"}
knitr::include_graphics("2020-03-30/Map_WHOAfrica_Cum_Cases.png")
```


\newpage

```{r rawCumDeaths, fig.height = 6, fig.width = 6, fig.align = "center"}
# Raw cumulative deaths ----

yseq = seq(0, max(d.deaths.long$cumNumDeaths) - (max(d.deaths.long$cumNumDeaths) %% 1), 1)
xseq = seq.Date(from = as.Date("2020-03-01"), to = max(d.deaths$date), by = 7)

plot('', xlim = range(xseq), ylim = range(yseq), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = format(xseq, "%d/%m"), font = 2)
axis(2, at = yseq, font = 2)
mtext('Cumulative number of deaths', side = 2, font = 2, line = 2.2)
mtext('Date (dd/mm)', side = 1, font = 2, line = 2.5)

abline(v = xseq, h = yseq, col = 'grey', lty = 'dotted')

tmp<- gather(tail(d.deaths,1)[-1], 'country', 'max') %>% arrange(-max)
d.tmp<- d.deaths[,c('date', rev(tmp$country))]

for(c in 2:ncol(d.tmp)){
  lines(d.tmp[,c] ~ d.tmp$date, lwd = 2, col = palette.f1[c])
}

x1 = range(xseq)[1]
x2 = range(xseq)[1] + diff(range(xseq)) * 0.4
y1 = range(yseq)[2]
y2 = range(yseq)[2] * 0.5

polygon(x = c(x1, x1, x2, x2),
        y = c(y1, y2, y2, y1),
        col = adjustcolor('grey', alpha = .2),
        border = NA)


ins.mar = (y1 - y2) * 0.1

topten.tmp<- data.frame(country = (tmp$country)[1:10]) %>%
  left_join(who.tab, by = 'country') %>%
  select(name_plot)

text(x = x1,
     y = rev(seq(y2+ins.mar, y1-ins.mar, length.out = 11)),
     lty = 2,
     labels = c('Region/Country:', paste0(' ', as.character(topten.tmp$name_plot))),
     col = c('black', rev(palette)),
     pos = 4,
     font = c(2, rep(1, 10)),
     cex = 0.8)

rm(tmp)
rm(d.tmp)
rm(topten.tmp)
rm(ins.mar)


```
&nbsp;

**Figure 4. Epidemic curve for WHO Africa Region based on deaths over time up to `r format(today, "%d/%m/%Y")`**. The ten countries with the highest current death toll are highlighted in colors according to legend in the inset.


\newpage

```{r LogCumPrevDeaths, fig.height = 6, fig.width = 6, fig.align = "center"}
# Log cumulative deaths per 10k pop ----

ylim.f2.min = min(d.deaths.10k.log.long$cumdeaths_10k_log, na.rm = TRUE) - min(d.deaths.10k.log.long$cumdeaths_10k_log, na.rm = TRUE) %% 1
ylim.f2.max = 0


yseq = seq(ylim.f2.min, ylim.f2.max, 1)
xseq = seq.Date(from = as.Date("2020-03-01"), to = max(d.deaths.10k.log.long$date), by = 7)


plot('', xlim = range(xseq), ylim = range(yseq), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = format(xseq, "%d/%m"), font = 2)
axis(2, at = yseq, font = 2)
mtext('Cumulative deaths per 10k pop. (log10)', side = 2, font = 2, line = 2.2)
mtext('Date (dd/mm)', side = 1, font = 2, line = 2.5)

abline(v = xseq, h = yseq, col = 'grey', lty = 'dotted')


tmp<- gather(tail(d.deaths.10k.log,1)[-1], 'country', 'max') %>% arrange(-max)
d.tmp<- d.deaths.10k.log[,c('date', rev(tmp$country))]


for(c in 2:ncol(d.tmp)){
  lines(d.tmp[,c] ~ d.tmp$date, lwd = 2, col = palette.f1[c])
}


x1 = xseq[1]
x2 = xseq[1] + diff(range(xseq)) * 0.4

y1 = range(yseq)[2]
y2 = range(yseq)[1] + diff(range(yseq)) * 0.5

polygon(x = c(x1, x1, x2, x2),
        y = c(y1, y2, y2, y1),
        col = adjustcolor('grey', alpha = .2),
        border = NA)


ins.mar = (y1 - y2) * 0.1

topten.tmp<- data.frame(country = (tmp$country)[1:10]) %>%
  left_join(who.tab, by = 'country') %>%
  select(name_plot)

text(x = x1,
     y = rev(seq(y2+ins.mar, y1-ins.mar, length.out = 11)),
     lty = 2,
     labels = c('Region/Country:', paste0(' ', as.character(topten.tmp$name_plot))),
     col = c('black', rev(palette)),
     pos = 4,
     font = c(2, rep(1, 10)),
     cex = 0.8)

rm(tmp)
rm(d.temp)
rm(topten.tmp)
rm(ins.mar)

```
&nbsp;

**Figure 5. Epidemic curve based on deaths, per 10k population up to `r format(today, "%d/%m/%Y")`**. The curves show the cumulated number of death per 10k population, on a log10 scale. The ten countries with the highest current death prevalence are highlighted in colors according to legend in the inset.


 \newpage


```{r AlignRawCumCases, echo=FALSE,  fig.height = 6, fig.width = 6, fig.align = "center"}
# Aligned cumulative cases ----
aligned_curves<- data.frame(day_since_start = c(0, cumsum(as.numeric(diff(d$date)))))

for(c in 2:ncol(d)){
d.temp = d[,c(1, c)]
d.temp.trim = d.temp[which(d.temp[,2] > 0), ]
d.temp.trim$day_since_start = c(0, cumsum(as.numeric(diff(d.temp.trim$date))))
d.temp.trim.f<- d.temp.trim[,c(3,2)]
aligned_curves<- 
  left_join(aligned_curves, d.temp.trim.f, by = 'day_since_start')
}


yseq = seq(0, max(aligned_curves, na.rm = TRUE) - max(aligned_curves, na.rm = TRUE) %% 200, 200)
xseq = seq(from = 0, to = max(aligned_curves$day_since_start), by = 7)
plot('', xlim = range(xseq), ylim = range(yseq), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = xseq, font = 2)
axis(2, at = yseq, font = 2)
mtext('Cumulative number of cases', side = 2, font = 2, line = 2.2)
mtext('Day since first reported case', side = 1, font = 2, line = 2.5)


foo.xseq<- seq(1, 100, 0.1)

polygon(x = c(0, 0, foo.xseq),
        y = c(0, 0, 10^((2/28)*foo.xseq)),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))

polygon(x = c(0, 0, rev(foo.xseq)),
        y = c(0, 0, rev(10^((2/21)*foo.xseq))),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))

polygon(x = c(0, 0, foo.xseq),
        y = c(0, 0, 10^((2/14)*foo.xseq)),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))

polygon(x = c(0, 0, foo.xseq),
        y = c(0, 0, 10^((2/7)*foo.xseq)),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))


lines(10^((2/7)*foo.xseq) ~ foo.xseq, col = 'darkgrey', lty = 'dashed', lwd = 2)
lines(10^((2/14)*foo.xseq) ~ foo.xseq, col = 'darkgrey', lty = 'dashed', lwd = 2)
lines(10^((2/21)*foo.xseq) ~ foo.xseq, col = 'darkgrey',lty = 'dashed', lwd = 2)
lines(10^((2/28)*foo.xseq) ~ foo.xseq, col = 'darkgrey', lty = 'dashed', lwd = 2)


for(c in 2:ncol(aligned_curves)){
  lines(aligned_curves[,c] ~ aligned_curves$day_since_start, lwd = 2)
}


```
&nbsp;

**Figure 6. Comparison of epidemic curves for WHO Africa Region as of `r format(today, "%d/%m/%Y")`**. The curves show the cumulated reported cases, aligned such that the x-axis shows the 'day since first reported case'). The ten countries with the highest current number of cases are highlighted in colors according to legend in the inset. Each colored area -also delimited by dashed- highlight a different doubling time windows of 7, 14, 21 and 28 days.

\newpage


```{r AlignLogCumPrevCases, echo=FALSE,  fig.height = 6, fig.width = 6, fig.align = "center"}
# Aligned cumulative cases on Log 10 scale ----

aligned_curves_10k.log<- 
  aligned_curves %>%
  gather('country', 'cumAlignedCases', 2:ncol(aligned_curves)) %>%
  left_join(pops, by = 'country') %>%
  mutate(cumAlignedCases_10k = cumAlignedCases * (10000/popsize)) %>%
  #na_if(0) %>%
  mutate(cumAlignedCases_10k_log = log10(cumAlignedCases_10k)) %>%
  select(day_since_start, country, cumAlignedCases_10k_log) %>%
  spread(country, cumAlignedCases_10k_log)




aligned_curves.log<- 
  cbind(day_since_start = aligned_curves$day_since_start,
        log10(aligned_curves[,2:ncol(aligned_curves)]))



ylim.min = min(aligned_curves_10k.log[,-1], na.rm = TRUE) - min(aligned_curves_10k.log[,-1], na.rm = TRUE) %% 1
ylim.max = 0


yseq = seq(ylim.min, ylim.max, 1)
xseq = seq(0, max(aligned_curves_10k.log$day_since_start), by = 7)


plot('', xlim = range(xseq), ylim = range(yseq), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = xseq, font = 2)
axis(2, at = yseq, font = 2)
mtext('Cumulative number of cases per 10k pop. (log10)', side = 2, font = 2, line = 2.2)
mtext('Day since first reported case', side = 1, font = 2, line = 2.5)


# NEED TO FIGURE OUT EQUATION FOR POLYGONS!


for(c in 2:ncol(aligned_curves_10k.log)){
  lines(aligned_curves_10k.log[,c] ~ aligned_curves_10k.log$day_since_start, lwd = 2)
}



```
&nbsp;

**Figure 7. Comparison of prevalence for WHO Africa Region as of `r format(today, "%d/%m/%Y")`**. The curves show the cumulated reported cases per 10000 population on a log10 scale, aligned such that the x-axis shows the 'day since first reported case'). The ten countries with the highest current prevalence are highlighted in colors according to legend in the inset. Each colored area -also delimited by dashed- highlight a different doubling time windows of 7, 14, 21 and 28 days.

\newpage


```{r histogramCases_and_Deaths, fig.height = 7, fig.width = 6, fig.align = "center"}

d.minus.deaths<- d[,2:ncol(d)] - d.deaths[,2:ncol(d.deaths)]
d.minus.deaths.max<- tail(d, 1)[,-1] - tail(d.deaths, 1)[,-1]
d.minus.deaths.max.long<- gather(d.minus.deaths.max, 'country', 'maxcases_minus_deaths')
d.deaths.max.long<- tail(d.deaths, 1)[,-1] %>% gather('country', 'maxdeaths')

dmax<- cbind(d.minus.deaths.max.long,
             deathsmax = d.deaths.max.long[,-1])
dmax2<- gather(dmax, 'variable', 'value', 2:3) %>% arrange(country)
dmax.1  = dmax %>% mutate(tot = maxcases_minus_deaths+deathsmax) %>% arrange(tot)
#dmax.1$country<- str_replace_all(dmax.1$country, '_', ' ')
#dmax2$country<- str_replace_all(dmax2$country, '_', ' ')
dmax2<- left_join(dmax2, dmax.1, by = 'country')
#dmax2$tot2<- ifelse(dmax2$variable == 'deathsmax', '', dmax2$tot)

dmax2$variable<- ifelse(dmax2$variable == 'deathsmax',
                        'Total cumulative deaths',
                        'Total cumulative cases (minus deaths)')

dmax2$country<- as.character(who.tab[match(dmax2$country, who.tab$country),'name_plot'])
dmax.1$country<- as.character(who.tab[match(dmax.1$country, who.tab$country),'name_plot'])


dmax2$country<- factor(dmax2$country, levels = dmax.1$country)


ggplot(dmax2, aes(x = country, y = value)) +
  ylim(0,max(dmax2$value)+100)+
  xlab('') + ylab("Total cumulative number")+
  geom_bar(aes(fill = variable), stat="identity") +
  geom_text(aes(label = paste0(dmax2$deathsmax, ' | ', dmax2$maxcases_minus_deaths), x = country, y = tot+30), size = 4, fontface = 2, hjust = 0)+
  scale_fill_manual(values = c('firebrick', 'black'))+
  coord_flip()+
  theme_bw()+
  theme(
    legend.position = c(.95, .05),
    legend.title = element_blank(),
    legend.text = element_text(size = 10, face = 2),
    legend.justification = c("right", "bottom"),
    legend.box.just = "left",
    legend.margin = margin(6, 6, 6, 6),
    panel.border= element_blank(),
    axis.text.y = element_text(face="bold", colour="black", size=9),
    axis.text.x = element_text(colour="black", face="bold", size=10),
    axis.title.y = element_text(face="bold", colour="black", size=11),
    axis.title.x = element_text(face="bold", colour="black", size=11),
    axis.line.y = element_line(color="black", size = 0.5),
    axis.line.x = element_line(color="black", size = 0.5),
    plot.title = element_text(lineheight=.8, face="bold", hjust = 0.5))


```

**Figure 8. Cumulated reported cases and deaths as of `r format(today, "%d/%m/%Y")`**. Deaths are subtracted from cases. The numbers right to each bar gives the exact numbers represented by the black and red sections of the bar.

\newpage


```{r  histogramCunInc10k, fig.height = 7, fig.width = 6, fig.align = "center"}

d.minus.deaths<- d[,2:ncol(d)] - d.deaths[,2:ncol(d.deaths)]
d.minus.deaths.max<- tail(d, 1)[,-1] - tail(d.deaths, 1)[,-1]
d.minus.deaths.max.long<- gather(d.minus.deaths.max, 'country', 'maxcases_minus_deaths')
d.deaths.max.long<- tail(d.deaths, 1)[,-1] %>% gather('country', 'maxdeaths')

dmax<- cbind(d.minus.deaths.max.long,
             deathsmax = d.deaths.max.long[,-1])
dmax2<- gather(dmax, 'variable', 'value', 2:3) %>% arrange(country)


d.cumInc10k<- 
gather(tail(d,1)[,-1], 'country', 'MaxCumCases') %>%
  left_join(pops, by = 'country') %>%
  mutate(cumInc_10k = MaxCumCases * (10000/popsize)) %>%
  arrange(cumInc_10k)

d.cumInc10k<- left_join(d.cumInc10k, who.tab, by = 'country')
d.cumInc10k$name_plot<- factor(d.cumInc10k$name_plot, levels = d.cumInc10k$name_plot)

ggplot(d.cumInc10k, aes(x = name_plot, y = cumInc_10k)) +
  #ylim(0,1)+
  xlab('') + ylab("Cumulative incidence per 10k pop.")+
  geom_bar(stat="identity", fill = 'black') +
  #geom_text(aes(label = , x = country, y = tot.10k), size = 4, fontface = 2, hjust = 0)+
  scale_colour_manual(values = c('black'))+
  coord_flip()+
  theme_bw()+
  theme(
    legend.position = 'none',
    legend.title = element_blank(),
    legend.text = element_text(size = 10, face = 2),
    legend.justification = c("right", "bottom"),
    legend.box.just = "left",
    legend.margin = margin(6, 6, 6, 6),
    panel.border= element_blank(),
    axis.text.y = element_text(face="bold", colour="black", size=9),
    axis.text.x = element_text(colour="black", face="bold", size=11),
    axis.title.y = element_text(face="bold", colour="black", size=11),
    axis.title.x = element_text(face="bold", colour="black", size=11),
    axis.line.y = element_line(color="black", size = 0.5),
    axis.line.x = element_line(color="black", size = 0.5),
    plot.title = element_text(lineheight=.8, face="bold", hjust = 0.5))


```
**Figure 9. Cumulative incidence per 10000 as of `r format(today, "%d/%m/%Y")`**.

\newpage

```{r DtCases, echo=FALSE,  fig.height = 9, fig.width = 7, fig.align = "center"}

# Doubling times ----

Td.report<- data.frame(variable = character(), Td.obs = numeric(), ci.low = numeric(), ci.upp = numeric(), t1 = character(), t2 = character())

its = 10

regions<- colnames(d)[-1]

sims.store<- vector('list', length = length(regions))



for(r in 1:length(regions)){
  
  d.clean<- # For focal country
    d[,c(1, which(colnames(d) == regions[r]))] %>%
    rename(cumNumCases = paste(regions[r])) %>%
    as.data.frame()
  
  
  d.clean.sim<- sim.epi(d.clean, its = its, plotsim = FALSE) # Simulate poisson error on raw cases
  
  d.clean.sim.cum<-
    d.clean.sim %>%
    select(-date, -cumNumCases) %>%
    mutate_all(~ cumsum(.)) %>%
    rename(cumNumCases = numNewCases) %>%
    cbind(date = d.clean.sim$date) %>%
    select(c(ncol(.), seq(1, ncol(.)-1)))
  
  
  t2<- tail(tail(d.clean.sim.cum$date, 8), 1) # t2: latest date
  t1<- head(tail(d.clean.sim.cum$date, 8), 1) # t1: t2 - 7 available time steps
  
  
  d.clean.sim.cum.list<- # Apply compute.td.m1.v2 on each dataset (via sapply)
    d.clean.sim.cum %>%
    select(-date) %>%
    as.list()
  
  Tds<- sapply(d.clean.sim.cum.list, Td.lapply, dates = d.clean.sim.cum$date, t1 = t1, t2 = t2)
  
  # Observed and bootstrap distribution of Tds
  Td.obs<- as.numeric(Tds['cumNumCases'])
  Td.bootstrap<- as.numeric(Tds[-which(names(Tds) == 'cumNumCases')])
  Td.bootstrap<- Td.bootstrap[!is.na(Td.bootstrap == TRUE)] # NAs come from cases where there were still zero cases observed at t1 in a simulated dataset. Normal to happen when still very low number of cases observed. Becomes less of a problem as number of cases rise.
  
  # Get CI from distribution of Td
  ci.low<- round(quantile(Td.bootstrap, c(0.05), method = 6), 1)[[1]]
  ci.upp<- round(quantile(Td.bootstrap, c(0.95), method = 6), 1)[[1]]
  
  #print(paste0(regions[r], ' : ', Td.obs, ' (', ci.low , ' - ', ci.upp , ')'))
  
  Td.report<- rbind(Td.report,
                    data.frame(variable = paste(regions[r]),
                               Td.obs = Td.obs[[1]],
                               ci.low = ci.low,
                               ci.upp = ci.upp,
                               t1 = t1,
                               t2 = t2)
  )
  
  
  d.clean.sim.cum$country = regions[r]
  sims.store[[r]]<- d.clean.sim.cum
  colnames(sims.store[[r]])[2]<- 'observed'
  
} 


Td.report.clean<- 
Td.report %>%
  rename(country = variable) %>%
  left_join(who.tab, by = 'country') %>%
  select(name_plot, Td.obs, ci.low, ci.upp) %>%
  rename(Country = name_plot,
         Dt = Td.obs)


Td.report.clean2<- 
  Td.report.clean %>%
  arrange(-Dt)

Td.report.clean2<- Td.report.clean2[-which(Td.report.clean2$ci.upp == 'Inf' | Td.report.clean2$ci.low == 'Inf' | Td.report.clean2$Dt == 'Inf'),]


# PLOT THE DOUBLING TIMES
plot('', xlim = -range(Td.report.clean2[,2:4])[c(2,1)], ylim = c(0, nrow(Td.report.clean2)+1),
     xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')

xseq<- c(-28, -21, -14, -7, -2, 1)
axis(1, at = xseq, labels = abs(xseq), font = 2)
#axis(2, at = seq(1, nrow(Td.report.clean2), 1), labels = Td.report.clean2$Country, font = 2, las = 2, cex.axis = 0.6)
ytick<- seq(1, nrow(Td.report.clean2), 1)
axis(side=2, at=ytick, labels = FALSE, tick = FALSE)
text(par("usr")[1], ytick,  
     labels = Td.report.clean2$Country, offset = -0.009, pos = 2, xpd = TRUE, font = 2, cex = 0.6)





mtext('Doubling time (days)', side = 1, font = 2, line = 2.5)

xlims<- -range(Td.report.clean2[,2:4])[c(2,1)]
polygon(x = c(rep(xlims[1], 2), rep(1, 2)),
        y = c(0, nrow(Td.report.clean2)+1, nrow(Td.report.clean2)+1, 0),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))


polygon(x = c(rep(1-(3*7+1), 2), rep(1, 2)),
        y = c(0, nrow(Td.report.clean2)+1, nrow(Td.report.clean2)+1, 0),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))

polygon(x = c(rep(1-(2*7+1), 2), rep(1, 2)),
        y = c(0, nrow(Td.report.clean2)+1, nrow(Td.report.clean2)+1, 0),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))

polygon(x = c(rep(1-(1*7+1), 2), rep(1, 2)),
        y = c(0, nrow(Td.report.clean2)+1, nrow(Td.report.clean2)+1, 0),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))


for(c in 1:nrow(Td.report.clean2)){
points(x = -Td.report.clean2$Dt[c], y = c, pch = 16)
lines(y = c(c,c), x = -Td.report.clean2[c,c('ci.low', 'ci.upp')], lwd = 2)
lines(y = c(c+0.2, c-0.2), x = -rep(Td.report.clean2$ci.low[c], 2), lwd = 2)
lines(y = c(c+0.2, c-0.2), x = -rep(Td.report.clean2$ci.upp[c], 2), lwd = 2)
}


write.csv(Td.report.clean2, '2020-03-30/Td.report.csv')

```
**Figure 10. Doubling time of cases `r format(today, "%d/%m/%Y")`**. Dt are calculated over a 7 days period from latest date.


\newpage

# By country figures

```{r , echo=FALSE,  fig.height = 6, fig.width = 6, fig.align = "center"}

countries<- colnames(d)


xseq = seq.Date(from = min(d$date), to = max(d$date), by = 7)

yseq.raw.cases = seq(0, roundup(max(d[,2:ncol(d)])), 500)
yseq.raw.deaths = seq(0, roundup(max(d.deaths[,2:ncol(d)])), 10)

yseq.log.cases = seq(floor(range(d.10k.log[,2:ncol(d.10k.log)], na.rm = TRUE)[1]),
                     ceiling(range(d.10k.log[,2:ncol(d.10k.log)], na.rm = TRUE)[2]),
                     1)
yseq.log.deaths = seq(floor(range(d.deaths.10k.log[,2:ncol(d.deaths.10k.log)], na.rm = TRUE)[1]),
                     ceiling(range(d.deaths.10k.log[,2:ncol(d.deaths.10k.log)], na.rm = TRUE)[2]),
                     1)


for(c in 2:ncol(d)){

par(mfrow = c(2,2),
          oma = c(1,2,3,1) + 0.1,
          mar = c(2,2,2,1) + 0.1)

# Raw cases
plot('', xlim = range(xseq), ylim = range(yseq.raw.cases), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = format(xseq, "%d/%m"), font = 2)
axis(2, at = yseq.raw.cases, font = 2)
for(c2 in 2:ncol(d)){
 lines(d[,c2] ~ d$date, lwd = 1.5, col = 'grey')
}
lines(d[,c] ~ d$date, lwd = 2)

# Log cases
plot('', xlim = range(xseq), ylim = range(yseq.log.cases), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = format(xseq, "%d/%m"), font = 2)
axis(2, at = yseq.log.cases, font = 2)
for(c2 in 2:ncol(d.10k.log)){
 lines(d.10k.log[,c2] ~ d.10k.log$date, lwd = 1.5, col = 'grey')
}
lines(d.10k.log[,c] ~ d.10k.log$date, lwd = 2)

# deaths raw
plot('', xlim = range(xseq), ylim = range(yseq.raw.deaths), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = format(xseq, "%d/%m"), font = 2)
axis(2, at = yseq.raw.deaths, font = 2)
for(c2 in 2:ncol(d.deaths)){
 lines(d.deaths[,c2] ~ d.deaths$date, lwd = 1.5, col = 'grey')
}
lines(d.deaths[,c] ~ d.deaths$date, lwd = 2)

# deaths log
plot('', xlim = range(xseq), ylim = range(yseq.log.deaths), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = format(xseq, "%d/%m"), font = 2)
axis(2, at = yseq.log.deaths, font = 2)
for(c2 in 2:ncol(d.deaths.10k.log)){
 lines(d.deaths.10k.log[,c2] ~ d.deaths.10k.log$date, lwd = 1.5, col = 'grey')
}
lines(d.deaths.10k.log[,c] ~ d.deaths.10k.log$date, lwd = 2)


mtext(paste(who.tab[match(countries[c], who.tab$country), 'name_plot']), side = 3, line = 0, outer = TRUE, col = 'black', cex = 2, font = 2)
mtext('Cases', side = 2, line = 0, outer = TRUE, col = 'black', cex = 1.1, font = 2, at = 0.75)
mtext('Deaths', side = 2, line = 0, outer = TRUE, col = 'black', cex = 1.1, font = 2, at = 0.25)
mtext('Cumulative numbers /10k pop. (log10)', side = 3, line = -1.5, outer = TRUE, col = 'black', cex = 0.9, font = 2, at = 0.77)
mtext('Cumulative numbers', side = 3, line = -1.5, outer = TRUE, col = 'black', cex = 0.9, font = 2, at = 0.25)

}

```

\newpage


# Data
TBC

# Methods
TBC
# Annexes

## Table reporting all cumulative incidence doubling times
**Note**: 95%CI reported as 'Inf' occur when countries have so few cases, resulting in huge uncertainty over the poisson error simulation. Likely, does not make much sense to compute CI based bootstrap for those cases.

```{r tabDt, results = 'asis', echo = FALSE}

kable(Td.report.clean)

```

\newpage

## Pairwise time difference (in days) of cumulative incidence per 10k population

```{r tabTimeDiff, results = 'asis', echo = FALSE}


pairs<- expand.grid(colnames(d.10k.log[,-1]), colnames(d.10k.log[,-1]))
pairs$Var1<- as.character(pairs$Var1)
pairs$Var2<- as.character(pairs$Var2)
pairs$time.diff<- NA
for(i in 1:nrow(pairs)){
  
  pairs$time.diff[i]<- epidemic.diff(d.10k.log, focal.country = as.character(pairs[i,1]), vs.country =  as.character(pairs[i,2]))
  
}


time.diff.df<- pairs %>%
  arrange(time.diff) %>%
  rename(`focal country` = Var1,
         `compared to` = Var2,
         `Time difference (days)` = time.diff)

time.diff.df$`focal country`<- who.tab[match(time.diff.df$`focal country`, who.tab$country), 'name_plot']
time.diff.df$`compared to`<- who.tab[match(time.diff.df$`compared to`, who.tab$country), 'name_plot']

kable(time.diff.df)

```



## Unevaluated Code (temp)

```{r alignCumDeath, echo=FALSE,  fig.height = 6, fig.width = 6, fig.align = "center", eval = FALSE}

# Aligned cumulative deaths ----

aligned_curves.deaths<- data.frame(day_since_start = c(0, cumsum(as.numeric(diff(d.deaths$date)))))
for(c in 2:ncol(d.deaths)){

  d.temp = d.deaths[,c(1, c)]
  
  if(tail(d.temp, 1)[,2] > 0){

  d.temp.trim = d.temp[which(d.temp[,2] > 0), ]
  d.temp.trim$day_since_start = c(0, cumsum(as.numeric(diff(d.temp.trim$date))))
  d.temp.trim.f<- d.temp.trim[,c(3,2)]

  aligned_curves.deaths<- 
    left_join(aligned_curves.deaths, d.temp.trim.f, by = 'day_since_start')
  
  }else{
    
    #print(paste('no deaths:', colnames(d.temp)[2]))
    d.temp.trim.f<- 
      data.frame(day_since_start = 0,
                 c = NA)
    colnames(d.temp.trim.f)[2]<- colnames(d.temp)[2]
    aligned_curves.deaths<- 
      left_join(aligned_curves.deaths, d.temp.trim.f, by = 'day_since_start')
  }
}

range(aligned_curves.deaths[,-1], na.rm = TRUE)

yseq = seq(0, max(aligned_curves.deaths[,-1], na.rm = TRUE) - max(aligned_curves.deaths[,-1], na.rm = TRUE) %% 1, 1)
xseq = seq(from = 0, to = max(aligned_curves.deaths$day_since_start), by = 7)
plot('', xlim = range(xseq), ylim = range(yseq), xaxt = 'n', yaxt = 'n', xlab = '', ylab = '')
axis(1, at = xseq, labels = xseq, font = 2)
axis(2, at = yseq, font = 2)
mtext('Cumulative number of deaths', side = 2, font = 2, line = 2.2)
mtext('Day since first reported death', side = 1, font = 2, line = 2.5)


foo.xseq<- seq(1, 100, 0.1)

polygon(x = c(0, 0, foo.xseq),
        y = c(1, 1, 10^((2/28)*foo.xseq)),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))

polygon(x = c(0, 0, rev(foo.xseq)),
        y = c(1, 1, rev(10^((2/21)*foo.xseq))),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))

polygon(x = c(0, 0, foo.xseq),
        y = c(1, 1, 10^((2/14)*foo.xseq)),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))

polygon(x = c(0, 0, foo.xseq),
        y = c(1, 1, 10^((2/7)*foo.xseq)),
        border = 'NA',
        col = adjustcolor('firebrick', alpha = .1))

lines(10^((2/7)*foo.xseq) ~ foo.xseq, col = 'darkgrey', lty = 'dashed', lwd = 2)
lines(10^((2/14)*foo.xseq) ~ foo.xseq, col = 'darkgrey', lty = 'dashed', lwd = 2)
lines(10^((2/21)*foo.xseq) ~ foo.xseq, col = 'darkgrey',lty = 'dashed', lwd = 2)
lines(10^((2/28)*foo.xseq) ~ foo.xseq, col = 'darkgrey', lty = 'dashed', lwd = 2)


for(c in 2:ncol(aligned_curves.deaths)){
  lines(aligned_curves.deaths[,c] ~ aligned_curves.deaths$day_since_start, lwd = 2)
}



```
&nbsp;


```{r histogramCases_and_Deaths10kLog, eval = FALSE}


dmax2.10k<- 
dmax2 %>%
  gather('elements', 'values', 3:ncol(dmax2)) %>%
  left_join(pops, by = 'country') %>%
  mutate(values_10k = values * (10000/popsize)) %>%
  na_if(0) %>%
  #mutate(values_10k_log = log10(values_10k)) %>%
  select(country, variable, elements, values_10k) %>%
  spread('elements', 'values_10k')


dmax.1.10k.log  = dmax %>% mutate(tot = maxcases_minus_deaths+deathsmax) %>% arrange(tot)


dmax.10k<- 
left_join(dmax, pops, by = 'country') %>%
  mutate(maxcases_minus_deaths.10k = maxcases_minus_deaths * (10000/popsize),
         deathsmax.10k = deathsmax * (10000/popsize)) %>%
  select(-popsize, -maxcases_minus_deaths, -deathsmax)


dmax2.10k<- gather(dmax.10k, 'variable', 'value', 2:3) %>% arrange(country)
dmax.1.10k  = dmax.10k %>% mutate(tot.10k = maxcases_minus_deaths.10k+deathsmax.10k) %>% arrange(tot.10k)

dmax.1.10k$country<- str_replace_all(dmax.1.10k$country, '_', ' ')
dmax2.10k$country<- str_replace_all(dmax2.10k$country, '_', ' ')
dmax2.10k<- left_join(dmax2.10k, dmax.1.10k, by = 'country')
#dmax2$tot2<- ifelse(dmax2$variable == 'deathsmax', '', dmax2$tot)

dmax2.10k$variable<- ifelse(dmax2.10k$variable == 'deathsmax.10k',
                        'Total cumulative deaths per 10k pop.',
                        'Total cumulative cases per 10k pop. (minus deaths)')

dmax2.10k$country<- factor(dmax2.10k$country, levels = dmax.1.10k$country)


ggplot(dmax2.10k, aes(x = country, y = value)) +
  #ylim(0,1)+
  xlab('') + ylab("Total cumulative number")+
  geom_bar(aes(fill = variable), stat="identity") +
  #geom_text(aes(label = , x = country, y = tot.10k), size = 4, fontface = 2, hjust = 0)+
  scale_fill_manual(values = c('firebrick', 'black'))+
  coord_flip()+
  theme_bw()+
  theme(
    legend.position = c(.95, .05),
    legend.title = element_blank(),
    legend.text = element_text(size = 10, face = 2),
    legend.justification = c("right", "bottom"),
    legend.box.just = "left",
    legend.margin = margin(6, 6, 6, 6),
    panel.border= element_blank(),
    axis.text.y = element_text(face="bold", colour="black", size=11),
    axis.text.x = element_text(colour="black", face="bold", size=11, vjust=1, hjust=1),
    axis.title.y = element_text(face="bold", colour="black", size=11),
    axis.title.x = element_text(face="bold", colour="black", size=11),
    axis.line.y = element_line(color="black", size = 0.5),
    axis.line.x = element_line(color="black", size = 0.5),
    plot.title = element_text(lineheight=.8, face="bold", hjust = 0.5))



```



```{r CunInc10kPoissonCI, echo=FALSE,  fig.height = 8, fig.width = 6, fig.align = "center"}

par(mfrow = c(4,3),
          oma = c(1,2,3,1) + 0.1,
          mar = c(2,2,2,1) + 0.1)

#r_remain = length(regions)
#plotted = 0
#while(r_remain > 0){
 
#leave_blank = ifelse(9-r_remain > 0, 9-r_remain, 0)

#par(mfrow = c(3,3))
#for(r in (plotted+1):((plotted+1)+(9 - leave_blank))){
#plotted = plotted + 1
for(r in 1:length(regions)){
sims.store[[r]]$sim.max = apply(sims.store[[r]][,which(substr(colnames(sims.store[[r]]), 1, 1) == 'V')], 1, max)
sims.store[[r]]$sim.min = apply(sims.store[[r]][,which(substr(colnames(sims.store[[r]]), 1, 1) == 'V')], 1, min)

focal.sims.store.10k.log<-
sims.store[[r]] %>%
  select(-country) %>%
  gather('set', 'value', 2:(ncol(sims.store[[r]])-1)) %>%
  mutate(value_10k = value * (10000/as.numeric(pops[which(pops$country == regions[r]),'popsize']))) %>%
  na_if(0) %>%
  mutate(value_10k_log = log10(value_10k)) %>%
  select(date, set, value_10k_log)


xseq = seq.Date(from = min(focal.sims.store.10k.log$date), to = max(focal.sims.store.10k.log$date), by = 7)
yseq.log.cases = seq(
floor(range(focal.sims.store.10k.log[focal.sims.store.10k.log$set == 'observed','value_10k_log'], na.rm = TRUE)[1]),
ceiling(range(focal.sims.store.10k.log[focal.sims.store.10k.log$set == 'observed','value_10k_log'], na.rm = TRUE)[2]),
1)


focal.sims.store.10k.log$value_10k_log[is.na(focal.sims.store.10k.log$value_10k_log)]<- min(yseq.log.cases)

focal.sims.store.10k.log<- 
  focal.sims.store.10k.log %>%
  spread(set, value_10k_log)

plot(observed ~ date, data = focal.sims.store.10k.log, type = 'l', ylab = '', xlab = '', xaxt = 'n', yaxt = 'n', main = str_replace_all(regions[r], '_', ' '))

axis(1, at = xseq, labels = format(xseq, "%d/%m"), font = 2)
axis(2, at = yseq.log.cases, font = 2)

abline(h = yseq.log.cases, v = xseq, col = 'grey', lty = 'dashed')

t0 = focal.sims.store.10k.log$date[1]
dates = focal.sims.store.10k.log$date
maxs = focal.sims.store.10k.log$sim.max
mins = focal.sims.store.10k.log$sim.min

polygon(x = c(t0, dates, rev(dates)),
        y = c(yseq.log.cases[1], maxs, rev(mins)),
        border = NA,
        col = adjustcolor('grey', alpha = .7))

lines(observed ~ date, data = focal.sims.store.10k.log, lwd = 2)


mtext('Cumulative numbers/10k pop. (log10)', side = 2, line = -1.5, outer = TRUE, col = 'black', cex = 0.9, font = 2, at = 0.5)
mtext('Date (dd/mm)', side = 1, line = -1.5, outer = TRUE, col = 'black', cex = 0.9, font = 2, at = 0.5)

#r_remain = length(regions) - plotted

}
```
